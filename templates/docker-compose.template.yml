services:
  dev-env:
    stdin_open: true  # Equivalent to -i flag in 'docker run'
    tty: true         # Equivalent to -t flag in 'docker run'

    image: ${IMAGE_NAME}
    hostname: ${CONTAINER_NAME}
    build:
      context: .
      dockerfile: ${DOCKERFILE_PATH:-dev-containers/templates/Dockerfile.template}
      args:
        - BASE_IMG=${BASE_IMG}
        - CACHE_BUSTER=${CACHE_BUSTER:-1}
        - HOST_USERNAME=${HOST_USERNAME:-dev}
        - HOST_UID=${HOST_UID:-1000}
        - HOST_GID=${HOST_GID:-1000}
      ssh:
        - default

    container_name: ${CONTAINER_NAME}
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"

    # Resource limits (can be overridden in environment config)
    deploy:
      resources:
        limits:
          cpus: '${CPU_LIMIT:-8.0}'
          memory: ${MEMORY_LIMIT:-16G}

    privileged: ${PRIVILEGED:-false}

    volumes:
      - ~/.zprofile:${USER_HOME:-/home/dev}/.zprofile # For PAT tokens mostly.
      - ${SSH_AUTH_SOCK}:/ssh-agent
      - .:/host
      - dev-vol:${USER_HOME:-/home/dev}/workspace

    environment:
      - SSH_AUTH_SOCK=/ssh-agent

    command: >
      bash -c "sudo chown -R $(id -u):$(id -g) ~/workspace 2>/dev/null; exec sleep infinity"
    working_dir: ${USER_HOME:-/home/dev}/workspace

volumes:
  dev-vol:
    external: true
